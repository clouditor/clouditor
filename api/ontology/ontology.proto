// Copyright 2024 Fraunhofer AISEC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
//           $$\                           $$\ $$\   $$\
//           $$ |                          $$ |\__|  $$ |
//  $$$$$$$\ $$ | $$$$$$\  $$\   $$\  $$$$$$$ |$$\ $$$$$$\    $$$$$$\   $$$$$$\
// $$  _____|$$ |$$  __$$\ $$ |  $$ |$$  __$$ |$$ |\_$$  _|  $$  __$$\ $$  __$$\
// $$ /      $$ |$$ /  $$ |$$ |  $$ |$$ /  $$ |$$ |  $$ |    $$ /  $$ |$$ | \__|
// $$ |      $$ |$$ |  $$ |$$ |  $$ |$$ |  $$ |$$ |  $$ |$$\ $$ |  $$ |$$ |
// \$$$$$$\  $$ |\$$$$$   |\$$$$$   |\$$$$$$  |$$ |  \$$$   |\$$$$$   |$$ |
//  \_______|\__| \______/  \______/  \_______|\__|   \____/  \______/ \__|
//
// This file is part of Clouditor Community Edition.

syntax = "proto3";

package clouditor.ontology.v1;

import "google/api/annotations.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "tagger/tagger.proto";
import "validate/validate.proto";

option go_package = "clouditor.io/clouditor/api/ontology";

message ResourceID {
  repeated string resource_id = 1;
}

message Container {}

message Document {
  string filename = 1;
  repeated SecurityFeature security_feature = 2;
}

message FileStorage {
  bool public_access = 1;
}

message Functionality {
  oneof type {
    HttpEndpoint http_endpoint = 101;
    HttpRequestHandler http_request_handler = 102;
    Operation operation = 103;
  }
}

// NetworkService is an entity in our Cloud ontology
// A NetworkService is an application (on the network layer) running on a Compute resource. It provides access to a resource
message NetworkService {
  repeated string ips = 1;
  repeated uint32 ports = 2;

  oneof type {
    LoadBalancer load_balancer = 101;
    LoggingService logging_service = 102;
    StorageService storage_service = 103;
  }
}

message AtRestEncryption {
  string algorithm = 1;
  bool enabled = 2;
  string key_url = 3;

  oneof type {
    CustomerKeyEncryption customer_key_encryption = 101;
    ManagedKeyEncryption managed_key_encryption = 102;
  }
}

// MalwareProtection is an entity in our Cloud ontology
// analyzes the activity within a Compute resource
message MalwareProtection {
  int32 number_of_threats_found = 1;
  bool enabled = 2;
  int64 days_since_active = 3;
}

message NetworkSecurityGroup {}

message ObjectStorage {
  bool public_access = 1;
}

message VirtualNetwork {}

message DeviceProvisioningService {}

message Logger {}

message RelationalDatabaseService {}

// AnomalyDetection is an entity in our Cloud ontology
// Analyzes the activity of a NetworkService (which includes DatabaseServices).
// AnomalyDetection is an entity in our Cloud ontology
// Scope contains the resource ID of the protected resource.
message AnomalyDetection {
  bool enabled = 1;
}

message CipherSuite {
  // for example: RSA, ECDSA
  string authentication_mechanism = 1;
  string key_exchange_algorithm = 2;
  // naming schema: SHA-256
  string mac_algorithm = 3;
  // naming schema: AES-128-GCM
  string session_cipher = 4;
}

message Identity {
  bool disable_password_policy = 1;
  bool enforce_m_f_a = 2;
  bool login_defender_enabled = 3;
  bool privileged = 4;
  google.protobuf.Timestamp last_activity = 5;
  repeated Authenticity authenticity = 6;
}

message ObjectStorageRequest {
  string type = 1;
  string source = 2;
}

message ContainerImage {}

// ObjectStorageService is an entity in our Cloud ontology
// An object storage service represents the network service that is used to access a list of object storage containers. The storage itself is modelled as a ObjectStorage. The service has an http endpoint.
message ObjectStorageService {}

message ActivityLogging {}

message Framework {
  oneof type {
    CloudSDK cloud_s_d_k = 101;
    HttpClientLibrary http_client_library = 102;
    HttpServer http_server = 103;
    Logger logger = 104;
  }
}

message Logging {
  bool monitoring_enabled = 1;
  bool security_alerts_enabled = 2;
  bool enabled = 3;
  int64 retention_period = 4;

  oneof type {
    ActivityLogging activity_logging = 101;
    ApplicationLogging application_logging = 102;
    BootLogging boot_logging = 103;
    OSLogging o_s_logging = 104;
    ResourceLogging resource_logging = 105;
  }
}

// LoggingService is an entity in our Cloud ontology
// A logging-as-a-service offering, e.g. for analyzing logs; has a Storage resource that stores the logs
message LoggingService {
  repeated ResourceID storage = 1;
}

// Account is an entity in our Cloud ontology
// This represents the cloud account as a whole, e.g., an Azure subscription.
message Account {}

message Compute {
  repeated ResourceID network_interface = 1;

  oneof type {
    Container container = 101;
    Function function = 102;
    VirtualMachine virtual_machine = 103;
    WebApp web_app = 104;
  }
}

message Networking {
  oneof type {
    NetworkInterface network_interface = 101;
    NetworkSecurityGroup network_security_group = 102;
    NetworkService network_service = 103;
    VirtualNetwork virtual_network = 104;
    VirtualSubNetwork virtual_sub_network = 105;
  }
}

message Workflow {}

message Function {
  string runtime_language = 1;
  string runtime_version = 2;
}

message Job {}

message Auditing {
  oneof type {
    AnomalyDetection anomaly_detection = 101;
    Logging logging = 102;
    MalwareProtection malware_protection = 103;
  }
}

message BootLogging {}

message DatabaseQuery {
  bool modify = 1;
}

message Immutability {
  bool enabled = 1;
}

// DatabaseStorage is an entity in our Cloud ontology
// describes the actual database or a table in a database
message DatabaseStorage {}

message HttpRequestHandler {
  string path = 1;
  repeated HttpEndpoint http_endpoint = 3;
}

message VMImage {}

message WebApp {}

message CloudResource {
  map<string, string> labels = 1;

  oneof type {
    Account account = 101;
    CICDService c_i_c_d_service = 102;
    Compute compute = 103;
    ContainerOrchestration container_orchestration = 104;
    ContainerRegistry container_registry = 105;
    Identifiable identifiable = 106;
    Image image = 107;
    IoT io_t = 108;
    Key key = 109;
    KeyVault key_vault = 110;
    Networking networking = 111;
    PasswordPolicy password_policy = 112;
    ResourceGroup resource_group = 113;
    Storage storage = 114;
  }
}

message DDoSProtection {}

// FileStorageService is an entity in our Cloud ontology
// An file storage service represents the network service that is used to access a list of file storage shares. The storage itself is modelled as a FileStorage. The service has an http endpoint.
message FileStorageService {}

message PasswordPolicy {}

message ResourceLogging {}

message Operation {
  oneof type {
    DatabaseOperation database_operation = 101;
    HttpRequest http_request = 102;
    LogOperation log_operation = 103;
    ObjectStorageRequest object_storage_request = 104;
  }
}

message Resource {
  string name = 1;

  oneof type {
    Application application = 101;
    CloudResource cloud_resource = 102;
    Document document = 103;
  }
}

message ContainerRegistry {}

message HttpRequest {
  string req_body = 1;
  string call = 2;
}

message DocumentDatabaseService {}

// Application is an entity in our Cloud ontology
// This encapsulates the whole (source) code of an application.
message Application {
  string programming_language = 1;
  repeated string translation_units = 2;
  repeated Functionality functionality = 3;
}

message IoT {
  oneof type {
    DeviceProvisioningService device_provisioning_service = 101;
    MessagingHub messaging_hub = 102;
  }
}

message PasswordBasedAuthentication {
  bool activated = 1;
}

message MessagingHub {}

message Redundancy {
  bool geo = 1;
  bool local = 2;
  bool zone = 3;
}

message CloudSDK {}

message ManagedKeyEncryption {}

message L3Firewall {
  bool enabled = 1;
  bool inbound = 2;
  string restricted_ports = 3;
}

// ProxiedEndpoint is an entity in our Cloud ontology
// An HTTP endpoint, that is routed through a (reverse) proxy, e.g. a load balancer.
message ProxiedEndpoint {}

message ResourceGroup {}

message ApplicationLogging {}

message Key {
  int64 expiration_date = 1;
  bool is_managed = 2;
  int32 length = 3;
  int32 number_of_usages = 4;
  bool enabled = 5;
}

message RBAC {
  // see Privacy Smells: Detecting Privacy Problems in Cloud Architectures (2020)
  float broad_assignments = 1;
  // see Privacy Smells: Detecting Privacy Problems in Cloud Architectures (2020)
  float mixed_duties = 2;
}

message CertificateBasedAuthentication {
  bool enabled = 1;
}

message Firewall {
  oneof type {
    L3Firewall l3_firewall = 101;
    WebApplicationFirewall web_application_firewall = 102;
  }
}

message BlockStorage {}

message HttpClientLibrary {}

message Identifiable {
  bool activated = 1;

  oneof type {
    Identity identity = 101;
    RoleAssignment role_assignment = 102;
  }
}

message SingleSignOn {
  bool enabled = 1;
}

message VirtualMachine {
  repeated ResourceID block_storage = 1;
}

message AccessRestriction {
  oneof type {
    Firewall firewall = 101;
  }
}

message CustomerKeyEncryption {
  string key_url = 1;
}

message Image {
  oneof type {
    ContainerImage container_image = 101;
    VMImage v_m_image = 102;
  }
}

// LogOperation is an entity in our Cloud ontology
// A LogOperation is used by an application
message LogOperation {
  string call = 1;
  string value = 2;
}

message SecurityFeature {
  oneof type {
    Auditing auditing = 101;
    Authenticity authenticity = 102;
    Authorization authorization = 103;
    Availability availability = 104;
    Confidentiality confidentiality = 105;
    Integrity integrity = 106;
  }
}

message ContainerOrchestration {
  string management_url = 1;
  repeated ResourceID container = 3;
}

// LoadBalancer is an entity in our Cloud ontology
// A Load Balancer may have multiple access restriction features, e.g. a L3 firewall and a WAF
message LoadBalancer {
  string url = 1;
  repeated HttpEndpoint http_endpoint = 2;
  repeated ResourceID network_service = 3;
}

// HttpEndpoint is an entity in our Cloud ontology
// Via the Authenticity relationship, the access type can be specified, e.g. public access (no authentication), password-based, etc.
message HttpEndpoint {
  string method = 1;
  string path = 2;
  string url = 3;
  string handler = 4;

  oneof type {
    ProxiedEndpoint proxied_endpoint = 101;
  }
}

message Authenticity {
  bool context_is_checked = 1;

  oneof type {
    CertificateBasedAuthentication certificate_based_authentication = 101;
    TokenBasedAuthentication token_based_authentication = 102;
    NoAuthentication no_authentication = 103;
    OTPBasedAuthentication o_t_p_based_authentication = 104;
    PasswordBasedAuthentication password_based_authentication = 105;
    SingleSignOn single_sign_on = 106;
  }
}

// AutomaticSecurityUpdates is an entity in our Cloud ontology
// This feature is, e.g., available on some VM services to automatically update their software. It ensures that a resource is protected from tampering with its state.
message AutomaticSecurityUpdates {
  bool security_only = 1;
  bool enabled = 2;
  // The interval refers to the update interval in days.
  int64 interval = 3;
}

// Backup is an entity in our Cloud ontology
// RetentionPeriod in hours
message Backup {
  bool enabled = 1;
  // The interval refers to the update interval in days.
  int64 interval = 2;
  int64 retention_period = 3;
}

message DatabaseOperation {
  repeated string calls = 1;

  oneof type {
    DatabaseConnect database_connect = 101;
    DatabaseQuery database_query = 102;
  }
}

// DatabaseService is an entity in our Cloud ontology
// This class represents a database service. For example, a postgres SQL server would be modelled as a database service (with a host and IP) and the individual tables or collections would be modelled as a DatabaseStorage entity.
message DatabaseService {
  oneof type {
    DocumentDatabaseService document_database_service = 101;
    KeyValueDatabaseService key_value_database_service = 102;
    RelationalDatabaseService relational_database_service = 103;
  }
}

message KeyValueDatabaseService {}

message CICDService {
  oneof type {
    Job job = 101;
    Workflow workflow = 102;
  }
}

message DatabaseConnect {}

message Integrity {
  oneof type {
    AutomaticSecurityUpdates automatic_security_updates = 101;
    Immutability immutability = 102;
  }
}

message Confidentiality {
  oneof type {
    AtRestEncryption at_rest_encryption = 101;
    CipherSuite cipher_suite = 102;
    EncryptionInUse encryption_in_use = 103;
    TransportEncryption transport_encryption = 104;
  }
}

message Storage {
  repeated Backup backup = 1;

  oneof type {
    BlockStorage block_storage = 101;
    DatabaseStorage database_storage = 102;
    FileStorage file_storage = 103;
    ObjectStorage object_storage = 104;
  }
}

message VirtualSubNetwork {}

// WebApplicationFirewall is an entity in our Cloud ontology
// A WAF is a L7 firewall that includes L3 capabilities
message WebApplicationFirewall {
  bool enabled = 1;
}

message RoleAssignment {}

// StorageService is an entity in our Cloud ontology
// This entity represents a network-based service that can be used to access a particular storage backend. It has multiple subclasses, e.g., for databases or object stores. It has a list of storage resources associated to it.
message StorageService {
  repeated ResourceID storage = 1;

  oneof type {
    DatabaseService database_service = 101;
    FileStorageService file_storage_service = 102;
    ObjectStorageService object_storage_service = 103;
  }
}

message HttpServer {}

message KeyVault {
  bool is_active = 1;
}

message OSLogging {}

// TransportEncryption is an entity in our Cloud ontology
// enabled means the resource _can_ be reached via https, while enforced means it _can only_ be reached via https (or http traffic is redirected)
message TransportEncryption {
  string protocol = 1;
  float protocol_version = 2;
  bool enabled = 3;
  bool enforced = 4;
  repeated CipherSuite cipher_suite = 5;
}

message Availability {
  oneof type {
    Backup backup = 101;
    DDoSProtection d_do_s_protection = 102;
    GeoLocation geo_location = 103;
    Redundancy redundancy = 104;
  }
}

message GeoLocation {
  string region = 1;
}

message TokenBasedAuthentication {
  bool enabled = 1;
  bool enforced = 2;
}

message NoAuthentication {}

message ABAC {}

message Authorization {
  oneof type {
    ABAC a_b_a_c = 101;
    AccessRestriction access_restriction = 102;
    RBAC r_b_a_c = 103;
  }
}

message EncryptionInUse {
  bool enabled = 1;
}

message NetworkInterface {}

message OTPBasedAuthentication {
  bool activated = 1;
}
